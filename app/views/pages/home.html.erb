<div class="background">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12">

        <div class="call-to-action d-flex justify-content-center mt-5">
          <strong>Plan Your Next Adventure - Find an Event Now!</strong>
        </div>

        <div class="d-flex justify-content-center mt-5">
          <div class="search search-form">
            <%= form_with(url: { action: "search_events" }, method: "get") do |form| %>

              <div class="search-container">
                <%= form.text_field :query, placeholder: "Sports in Melbourne...", class: "search-input", autocomplete: "off"%>
                <div class="search-date-image"><i class="fa-regular fa-calendar"></i></div>
                <%= form.text_field :date, placeholder: nil, class: "search-date", data: { controller: "datepicker" } %>
                <div class="search-date-image"><i class="fa-solid fa-magnifying-glass"></i></div>
                <button type="submit" class="search-button"></button>
              </div>

          <% end %>
        </div>
      </div>

      <div class="d-flex mt-5 justify-content-center">
        <% if @api_events.present? %>
          <% if @date.present? %>
            <p>Showing results for <%= @query.capitalize %> around <%= Date.parse(@date).strftime('%d %b') %></p>
          <% end %>
        <% end %>
      </div>

        <div class="container-search">
          <div class="search-results row" data-controller="search" data-search-api-events="<%= @api_events.to_json %>">
            <% if @api_events.present? %>
              <% @api_events.each_with_index do |event, index| %>
                <div class="card" data-controller="button-logic">
                  <img src=<%= event["thumbnail"] %> alt="Event Image">
                  <div class="card-content">
                    <div class="card-title" data-button-logic-target="eventName"><%= event["title"] %></div>
                    <div class="card-address"><%= event["address"].join(", ") %></div>
                    <div class="card-date"><%= event["date"]["start_date"] if event["date"] %></div>
                    <div class="card-description"><%= event["description"] %></div>
                  </div>
                  <div class="card-actions d-flex justify-content-center" id="event-card-buttons">
                    <div  data-button-logic-target="saveButtonForm">
                      <%= button_to "Save Event", create_from_api_path(event), class: "btn btn-dark", turbo_method: :post, "data-action": "click->button-logic#handleSaveClick" %>
                    </div>


                    <!-- Success Modal -->
                    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="successModalLabel">Success</h5>
                          </div>
                          <div class="modal-body">
                            Event saved successfully!
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Error Modal -->
                    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="errorModalLabel">Wait</h5>
                          </div>
                          <div class="modal-body">
                            Event already tagged!
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#purchase-<%= index %>">Purchase</button>
                    <div class="modal fade" id="purchase-<%= index %>" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="purchase" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h2>Where would you like to purchase?</h2>
                          </div>
                          <div class="modal-body purchase">
                            <div class="d-flex flex-column align-items-center">
                              <% event["ticket_info"].each do |vendor| %>
                                <div class="p-2">
                                  <a class="btn btn-primary" href="<%= vendor["link"] %>" target="_blank"><%= vendor["source"] %></a>
                                </div>
                              <% end %>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="reset" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              <% end %>
              <% if @api_events.size == 10 %>
                <div class="see-more-card d-flex justify-content-center align-items-center">
                  <div class="see-more">
                    <%= form_with(url: { action: "search_events" }, method: "get") do |form| %>
                      <%= form.hidden_field :query, value: @query %>
                      <%= form.hidden_field :date, value: @date %>
                      <%= form.hidden_field :start, value: params[:start].to_i + 10 %>
                      <%= form.submit "See more results", class: "btn btn-dark" %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <%= render "shared/all_events" %>
            <% end %>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
